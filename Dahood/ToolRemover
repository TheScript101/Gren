-- LocalScript inside StarterGui
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local backpack = player:WaitForChild("Backpack")

-- Main ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ToolRemoverGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Toggle Button (shows/hides whole frame)
local toggleGuiBtn = Instance.new("TextButton")
toggleGuiBtn.Size = UDim2.new(0, 38, 0, 38)
toggleGuiBtn.Position = UDim2.new(1, -278, 0.35, -167)
toggleGuiBtn.Text = "⚙️"
toggleGuiBtn.Font = Enum.Font.Gotham
toggleGuiBtn.TextSize = 20
toggleGuiBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
toggleGuiBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleGuiBtn.Name = "ToggleBuilder"
toggleGuiBtn.Parent = screenGui
toggleGuiBtn.AutoButtonColor = true

-- Main Frame (bigger for items + remover)
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 300, 0, 300)
frame.Position = UDim2.new(0.5, -150, 0.5, -150)
frame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
frame.BorderSizePixel = 0
frame.Visible = true
frame.Parent = screenGui
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)
local stroke = Instance.new("UIStroke", frame)
stroke.Thickness = 2
stroke.Color = Color3.fromRGB(70, 70, 70)

-- My Items Label (always shown)
local myItemsLabel = Instance.new("TextLabel")
myItemsLabel.Size = UDim2.new(1, -20, 0, 30)
myItemsLabel.Position = UDim2.new(0, 10, 0, 10)
myItemsLabel.Text = "My Items"
myItemsLabel.Font = Enum.Font.GothamBold
myItemsLabel.TextSize = 18
myItemsLabel.BackgroundColor3 = Color3.fromRGB(60, 120, 200)
myItemsLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
myItemsLabel.Parent = frame
Instance.new("UICorner", myItemsLabel).CornerRadius = UDim.new(0, 8)

-- ScrollingFrame (always visible)
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Size = UDim2.new(1, -20, 0, 100)
scrollFrame.Position = UDim2.new(0, 10, 0, 50)
scrollFrame.BackgroundTransparency = 1
scrollFrame.ScrollBarThickness = 6
scrollFrame.Parent = frame

local layout = Instance.new("UIGridLayout")
layout.CellSize = UDim2.new(0, 50, 0, 50)
layout.CellPadding = UDim2.new(0, 5, 0, 5)
layout.Parent = scrollFrame

-- Tool Remover Section
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -20, 0, 25)
title.Position = UDim2.new(0, 10, 0, 160)
title.BackgroundTransparency = 1
title.Text = "Tool Remover"
title.Font = Enum.Font.GothamBold
title.TextSize = 18
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextXAlignment = Enum.TextXAlignment.Center
title.Parent = frame

local textBox = Instance.new("TextBox")
textBox.Size = UDim2.new(0.8, 0, 0, 30)
textBox.Position = UDim2.new(0.1, 0, 0, 195)
textBox.PlaceholderText = "Enter tool name..."
textBox.Text = ""
textBox.ClearTextOnFocus = true
textBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
textBox.TextColor3 = Color3.fromRGB(255, 255, 255)
textBox.Font = Enum.Font.Gotham
textBox.TextSize = 16
textBox.Parent = frame
Instance.new("UICorner", textBox).CornerRadius = UDim.new(0, 8)

local confirmBtn = Instance.new("TextButton")
confirmBtn.Size = UDim2.new(0.5, 0, 0, 30)
confirmBtn.Position = UDim2.new(0.25, 0, 0, 235)
confirmBtn.Text = "Confirm"
confirmBtn.Font = Enum.Font.GothamBold
confirmBtn.TextSize = 16
confirmBtn.BackgroundColor3 = Color3.fromRGB(60, 200, 120)
confirmBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
confirmBtn.Parent = frame
Instance.new("UICorner", confirmBtn).CornerRadius = UDim.new(0, 8)

-- toggle state so refreshes won't override user choice
local frameHidden = false
toggleGuiBtn.MouseButton1Click:Connect(function()
    frameHidden = not frameHidden
    frame.Visible = not frameHidden
end)

-- Confirm Button Logic (deletes tool from backpack or character)
confirmBtn.MouseButton1Click:Connect(function()
    local toolName = textBox.Text
    if toolName ~= "" then
        local character = player.Character or player.CharacterAdded:Wait()
        local tool = backpack:FindFirstChild(toolName)
        if tool then tool:Destroy() end
        local charTool = character:FindFirstChild(toolName)
        if charTool then charTool:Destroy() end
    end
end)

-- Helper: try to find an image for a tool (Tool.TextureId, Handle.Decal, SpecialMesh/ Mesh.TextureId, Handle.Texture)
local function findToolImage(tool)
    if not tool then return nil end

    if tool:IsA("Tool") then
        local ok, tId = pcall(function() return tool.TextureId end)
        if ok and tId and tostring(tId) ~= "" then return tostring(tId) end
    end

    local handle = tool:FindFirstChild("Handle")
    if handle then
        local decal = handle:FindFirstChildOfClass("Decal")
        if decal and decal.Texture and decal.Texture ~= "" then
            return decal.Texture
        end

        for _, child in ipairs(handle:GetChildren()) do
            if child:IsA("SpecialMesh") or child:IsA("Mesh") then
                local ok2, tex = pcall(function() return child.TextureId end)
                if ok2 and tex and tostring(tex) ~= "" then
                    return tostring(tex)
                end
            end
        end

        local ok3, hTex = pcall(function() return handle.TextureID or handle.Texture end)
        if ok3 and hTex and tostring(hTex) ~= "" then
            return tostring(hTex)
        end
    end

    return nil
end

-- Refresh items list (only rebuilds bubbles; does NOT change frame.Visible)
local function refreshItems()
    -- don't touch frame.Visible here (toggle manages that)
    -- clear previous item buttons while keeping the UIGridLayout
    for _, child in ipairs(scrollFrame:GetChildren()) do
        if child ~= layout then
            child:Destroy()
        end
    end

    local function createBubbleForTool(tool)
        if not tool or not tool.Parent then return end

        local itemBtn = Instance.new("TextButton")
        itemBtn.Name = "ItemBtn_" .. tostring(tool.Name)
        itemBtn.Size = UDim2.new(0, 50, 0, 50)
        itemBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        itemBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        itemBtn.Font = Enum.Font.GothamBold
        itemBtn.Parent = scrollFrame
        Instance.new("UICorner", itemBtn).CornerRadius = UDim.new(1, 0)

        local imageId = findToolImage(tool)
        if imageId and imageId ~= "" then
            itemBtn.Text = ""
            local icon = Instance.new("ImageLabel")
            icon.Size = UDim2.new(1, -8, 1, -8)
            icon.Position = UDim2.new(0, 4, 0, 4)
            icon.BackgroundTransparency = 1
            icon.Image = imageId
            icon.Parent = itemBtn
            Instance.new("UICorner", icon).CornerRadius = UDim.new(1, 0)
        else
            itemBtn.Text = tool.Name
            itemBtn.TextScaled = true
            itemBtn.TextWrapped = true
        end

        itemBtn.MouseButton1Click:Connect(function()
            textBox.Text = tool.Name
        end)
    end

    -- Add tools in Backpack
    for _, tool in ipairs(backpack:GetChildren()) do
        if tool:IsA("Tool") then
            createBubbleForTool(tool)
        end
    end

    -- Add equipped tools in Character
    local character = player.Character
    if character then
        for _, tool in ipairs(character:GetChildren()) do
            if tool:IsA("Tool") then
                createBubbleForTool(tool)
            end
        end
    end

    -- update canvas size
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y)
end

-- Live updates when backpack or character changes (keeps tools visible when equipped)
backpack.ChildAdded:Connect(refreshItems)
backpack.ChildRemoved:Connect(refreshItems)

player.CharacterAdded:Connect(function(char)
    -- whenever you respawn, refresh immediately so backpack shows up
    task.defer(refreshItems)

    char.ChildAdded:Connect(refreshItems)
    char.ChildRemoved:Connect(refreshItems)
end)

-- initial
refreshItems()

-- periodic refresh every 2 seconds (keeps list in sync across deaths)
task.spawn(function()
    while task.wait(2) do
        refreshItems()
    end
end)
